<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Subtitle Downloader</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>YouTube Subtitle Downloader</h1>
            <p class="subtitle">Download subtitles or generate transcripts from YouTube videos</p>
        </header>
        
        <div class="card">
            <div class="input-group">
                <input type="text" id="url" placeholder="Enter YouTube Video URL" 
                       aria-label="YouTube Video URL">
            </div>
            
            <div class="quality-selector">
                <div class="quality-buttons">
                    <div class="quality-button selected" data-model="small" id="standard-quality">
                        Standard (Faster)
                    </div>
                    <div class="quality-button" data-model="medium" id="premium-quality">
                        Premium (More Accurate)
                    </div>
                </div>
            </div>
            
            <div class="language-selector">
                <label for="language-select">Language:</label>
                <select id="language-select">
                    <option value="auto" selected>Auto Detect</option>
                    <!-- More options will be populated via JavaScript -->
                </select>
            </div>
            
            <div class="action-buttons">
                <button id="download-btn">
                    Download Existing Transcript
                </button>
                <button id="generate-btn">
                    Generate New Transcript
                </button>
            </div>
        </div>
        
        <div id="status-indicator" class="status-indicator">
            <div id="loading-spinner" class="loading-spinner"></div>
            <span id="status-message">Processing...</span>
        </div>
        
        <div id="result-container" class="result-container card">
            <h3>Download Results</h3>
            <div id="output-message"></div>
            
            <ul id="file-list" class="file-list"></ul>
            
            <div id="transcript-notice" class="transcript-notice" style="display: none;">
                <p>
                    If you're not satisfied with the existing transcript, use 
                    <strong>"Generate New Transcript"</strong> for higher-quality results.
                </p>
            </div>
        </div>
        
        <div id="transcript-container" class="transcript-container">
            <div class="transcript-toolbar">
                <h3>Transcript Content</h3>
                <div>
                    <button id="copy-btn" class="copy-btn">
                        Copy
                    </button>
                    <button id="save-btn" class="save-btn">
                        Save as File
                    </button>
                </div>
            </div>
            
            <div id="transcript-content" class="transcript-content"></div>
        </div>
        
        <footer>
            <p>Powered by advanced transcription technology</p>
        </footer>
    </div>

    <script>
        let selectedModel = 'small'; // Default model
        let selectedLanguage = 'auto'; // Default language
        
        // Initialize elements
        const statusIndicator = document.getElementById('status-indicator');
        const resultContainer = document.getElementById('result-container');
        const transcriptContainer = document.getElementById('transcript-container');
        const outputMessage = document.getElementById('output-message');
        const fileList = document.getElementById('file-list');
        const transcriptContent = document.getElementById('transcript-content');
        const downloadBtn = document.getElementById('download-btn');
        const generateBtn = document.getElementById('generate-btn');
        const transcriptNotice = document.getElementById('transcript-notice');
        const standardQualityBtn = document.getElementById('standard-quality');
        const premiumQualityBtn = document.getElementById('premium-quality');
        const languageSelect = document.getElementById('language-select');
        
        let originalTranscript = '';
        let isGenerated = false;
        
        // Load available languages from backend
        fetchLanguages();
        
        // Set default selection
        standardQualityBtn.classList.add('selected');
        
        // Event listeners for quality selection
        standardQualityBtn.addEventListener('click', function() {
            selectQuality('small', 'standard');
        });
        
        premiumQualityBtn.addEventListener('click', function() {
            selectQuality('medium', 'premium');
        });
        
        // Language selection event
        languageSelect.addEventListener('change', function() {
            selectedLanguage = this.value;
        });
        
        function selectQuality(model, quality) {
            selectedModel = model;
            if (quality === 'standard') {
                standardQualityBtn.classList.add('selected');
                premiumQualityBtn.classList.remove('selected');
            } else {
                premiumQualityBtn.classList.add('selected');
                standardQualityBtn.classList.remove('selected');
            }
        }
        
        // Fetch available languages from API
        function fetchLanguages() {
            fetch('/languages')
                .then(response => response.json())
                .then(languages => {
                    languageSelect.innerHTML = ''; // Clear existing options
                    Object.keys(languages).forEach(code => {
                        const option = document.createElement('option');
                        option.value = code;
                        option.textContent = languages[code];
                        if (code === 'auto') option.selected = true;
                        languageSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Failed to load languages:', error);
                });
        }
        
        // Enter key event on URL input
        document.getElementById('url').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                downloadBtn.click();
            }
        });
        
        // Download button event
        downloadBtn.addEventListener('click', function() {
            processRequest(false);
        });
        
        // Generate button event
        generateBtn.addEventListener('click', function() {
            processRequest(true);
        });
        
        // Copy button event
        document.getElementById('copy-btn').addEventListener('click', function() {
            copyTranscript();
        });
        
        // Save button event
        document.getElementById('save-btn').addEventListener('click', function() {
            downloadTranscript();
        });
        
        function setStatus(message, type) {
            statusIndicator.className = 'status-indicator';
            statusIndicator.classList.add(`status-${type}`);
            document.getElementById('status-message').textContent = message;
            statusIndicator.style.display = 'flex';
            
            if (type === 'loading') {
                document.getElementById('loading-spinner').style.display = 'block';
            } else {
                document.getElementById('loading-spinner').style.display = 'none';
            }
        }
        
        function resetUI() {
            resultContainer.style.display = 'none';
            transcriptContainer.style.display = 'none';
            fileList.innerHTML = '';
            transcriptContent.innerHTML = '';
            statusIndicator.style.display = 'none';
            transcriptNotice.style.display = 'none';
            originalTranscript = '';
            isGenerated = false;
        }
        
        function isValidYouTubeUrl(url) {
            const regex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.?be)\/.+$/;
            return regex.test(url);
        }
        
        function extractVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }
        

        function processRequest(generateNew) {
            const url = document.getElementById('url').value.trim();
            
            if (!url) {
                setStatus('Please enter a YouTube video URL', 'error');
                return;
            }
            
            if (!isValidYouTubeUrl(url)) {
                setStatus('Please enter a valid YouTube URL', 'error');
                return;
            }
            
            // Reset UI completely
            resetUI();
            
            // Explicitly set the isGenerated flag
            isGenerated = generateNew;
            
            if (generateNew) {
                const qualityLevel = selectedModel === 'medium' ? 'premium' : 'standard';
                setStatus(`Generating new transcript with ${qualityLevel} quality... This may take several minutes for longer videos.`, 'loading');
            } else {
                setStatus('Downloading existing subtitles... Please wait.', 'loading');
            }
            
            downloadBtn.disabled = true;
            generateBtn.disabled = true;
            
            // Create the form data with clear boolean value
            const formData = new FormData();
            formData.append('url', url);
            formData.append('model', selectedModel);
            formData.append('force_transcribe', generateNew ? 'true' : 'false');
            formData.append('language', selectedLanguage);
            
            console.log(`Sending ${generateNew ? 'generation' : 'download'} request with force_transcribe=${generateNew}`);
            
            fetch('/download', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Response from server:', data);
                processResponse(data, generateNew);
            })
            .catch(error => {
                console.error('Error:', error);
                setStatus('An error occurred while processing the request. Please try again.', 'error');
                downloadBtn.disabled = false;
                generateBtn.disabled = false;
            });
        }

        // 修改processResponse函数以接收generateNew参数
        function processResponse(response, wasGenerateRequest) {
            // 启用按钮
            downloadBtn.disabled = false;
            generateBtn.disabled = false;
            
            if (response.status === 'success') {
                // 根据请求类型设置不同的成功消息
                if (wasGenerateRequest) {
                    setStatus('Successfully generated new transcript!', 'success');
                } else {
                    setStatus('Successfully downloaded existing transcript!', 'success');
                }
                
                resultContainer.style.display = 'block';
                outputMessage.textContent = response.message;
                
                if (response.files && response.files.length > 0) {
                    fileList.innerHTML = response.files.map(file => 
                        `<li>
                            <span>${file}</span>
                            <a href="/static/${file}" class="download-link" download>
                                Download
                            </a>
                        </li>`
                    ).join('');
                }
                
                if (response.transcript) {
                    originalTranscript = response.transcript;
                    transcriptContainer.style.display = 'block';
                    
                    // 只有在非生成模式下才显示提示
                    if (!wasGenerateRequest && (response.source === 'youtube' || response.source === 'subtitles')) {
                        transcriptNotice.style.display = 'block';
                    } else {
                        transcriptNotice.style.display = 'none';
                    }
                    
                    // 处理transcript
                    transcriptContent.innerHTML = '';
                    const paragraphs = response.transcript.split(/\n\s*\n/);
                    
                    paragraphs.forEach(paragraph => {
                        if (paragraph.trim() === '') return;
                        
                        const paragraphElement = document.createElement('div');
                        paragraphElement.className = 'transcript-line';
                        paragraphElement.textContent = paragraph.trim();
                        transcriptContent.appendChild(paragraphElement);
                    });
                }
            } else if (response.status === 'not_found') {
                setStatus(response.message, 'error');
            } else {
                setStatus(`Error: ${response.message}`, 'error');
            }
        }




        function copyTranscript() {
            navigator.clipboard.writeText(originalTranscript).then(() => {
                const copyBtn = document.getElementById('copy-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            });
        }
        
        function downloadTranscript() {
            const videoId = extractVideoId(document.getElementById('url').value);
            const fileName = videoId ? `transcript_${videoId}.txt` : 'transcript.txt';
            
            const blob = new Blob([originalTranscript], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const saveBtn = document.getElementById('save-btn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saved!';
            setTimeout(() => {
                saveBtn.textContent = originalText;
            }, 2000);
        }
    </script>
</body>
</html>